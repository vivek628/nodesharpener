'use strict';

const expect = require('chai').expect;
const path = require('path');
const fs = require('fs');
const nodeStorage = require('../index.js');
const NodeStorage = require('../modules/storage/NodeStorage.js');

const readFile = path => {
  return fs.readFileSync(path).toString();
};

describe('Node Storage Module', function() {
  const pathToDb = path.resolve(__dirname, './dbs/jsondb.json');
  let storage;

  describe('Opening Existing DB', function() {

    it('Call module#storage', function() {
      storage = nodeStorage.storage(pathToDb);

      expect(true).to.equal(storage instanceof NodeStorage);
    });

    it('List', function() {
      var val = [{
        key: 'a',
        value: 'v'
      }];

      expect(val).to.eql(storage.list);
    });
  });

  describe('Set && Update fields', function() {
    it('Set New Item', function(done) {
      storage.setItem('b', 'c');
      storage.setItem('a', 'e');
      this.timeout(100);
      setTimeout(done, 90);
    });

    it('File Has Changed', function() {
      var expectedStr = '[{"key":"a","value":"e"},{"key":"b","value":"c"}]';
      expect(expectedStr).to.equal(readFile(pathToDb));

      // fix state
      fs.writeFileSync(pathToDb, '[{"key":"a","value":"v"}]');
    });
  });
});
